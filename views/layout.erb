<!DOCTYPE html>
<head>
<meta name="viewport" content="initial-scale=1, maximum-scale=1">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<% if params.has_key?(:tok) || params.has_key?(:u) %>
<link rel="manifest" href="/manifest.webmanifest?tok=<%= params[:tok] %>" />
<% end %>
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.js"></script>

<script src="/nomadic.js"></script>

<script src="/html5-qrcode.min.js"></script>
     
</head>
<body style="width: 100vw; height: 100vh; text-align: center; margin: 0; padding: 0;">
  <%# Redis.new.publish("LAYOUT", "#{params}") %>
  <%= yield %>
  <script>
    <% if params.has_key? :wipe %>localStorage.clear();<% end %>

    <% if params.has_key?(:tok) || params.has_key?(:u) %>
      <% @now = "#{Time.now.utc.to_i}" %>
      <% if params.has_key?(:u) %>
        <% @book = Redis::HashKey.new("uid")[params[:u]] %>
    var cb = "<%= @book %>";
        <% @me = @here.cloud.user(@book) %>
    var tk = "<%= @me.attr['uid'] %>" + "<%= @now %>";
        <% @mode = 'append' %>
      <% else %>
        <% @me = @here.cloud.user(@here.ticket(params[:tok]).active?('token')) %>
    var tk = '<%= params[:tok] %>';
        <% @mode = 'connect' %>
      <% end %>
    var tok = localStorage.getItem('token');
    console.log("TOK:0", tok);
    if ( tok == null || tk != tok) {
	localStorage.setItem('token', tk);
	tok = localStorage.getItem('token');
    }
    <% end %>
    console.log("TOK:1", tok);

    
    if ('serviceWorker' in navigator) {
	// Register a service worker hosted at the root of the
	// site using the default scope.
	navigator.serviceWorker.register('/service.js?tok=<%= params[:tok] %>').then(function(registration) {
	    console.log('Service worker registration succeeded:', registration);
	}, /*catch*/ function(error) {
	    console.log('Service worker registration failed:', error);
	});
    } else {
	console.log('Service workers are not supported.');
    }
    const me = "user/<%= params[:tok] %>";
    let client = new Paho.MQTT.Client('vango.me', 8083, '<%= params[:tok] %>');
    let html5QrcodeScanner = new Html5QrcodeScanner( "reader", { fps: 10, qrbox: 250 }, false);
  </script>
</body>
